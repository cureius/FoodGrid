<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
    xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="
      http://www.liquibase.org/xml/ns/dbchangelog
      http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-4.9.xsd">

  <!-- Client Payment Gateway Configuration -->
  <changeSet id="4-create-client-payment-config" author="dev">
    <createTable tableName="client_payment_configs">
      <column name="id" type="varchar(36)">
        <constraints primaryKey="true" nullable="false"/>
      </column>
      <column name="client_id" type="varchar(36)">
        <constraints nullable="false"/>
      </column>
      <column name="gateway_type" type="varchar(50)">
        <constraints nullable="false"/>
      </column>
      <column name="api_key_encrypted" type="text">
        <constraints nullable="false"/>
      </column>
      <column name="secret_key_encrypted" type="text">
        <constraints nullable="false"/>
      </column>
      <column name="webhook_secret_encrypted" type="text"/>
      <column name="merchant_id" type="varchar(255)"/>
      <column name="is_active" type="boolean" defaultValueBoolean="true"/>
      <column name="is_live_mode" type="boolean" defaultValueBoolean="false"/>
      <column name="additional_config" type="text"/>
      <column name="created_at" type="datetime"/>
      <column name="updated_at" type="datetime"/>
    </createTable>

    <addForeignKeyConstraint
        baseTableName="client_payment_configs"
        baseColumnNames="client_id"
        referencedTableName="clients"
        referencedColumnNames="id"
        constraintName="fk_payment_config_client"/>

    <createIndex tableName="client_payment_configs" indexName="idx_payment_config_client">
      <column name="client_id"/>
    </createIndex>

    <createIndex tableName="client_payment_configs" indexName="idx_payment_config_active">
      <column name="client_id"/>
      <column name="is_active"/>
    </createIndex>
  </changeSet>

  <!-- Gateway Transactions Table -->
  <changeSet id="4-create-gateway-transactions" author="dev">
    <createTable tableName="gateway_transactions">
      <column name="id" type="varchar(36)">
        <constraints primaryKey="true" nullable="false"/>
      </column>
      <column name="tenant_id" type="varchar(36)">
        <constraints nullable="false"/>
      </column>
      <column name="client_id" type="varchar(36)">
        <constraints nullable="false"/>
      </column>
      <column name="outlet_id" type="varchar(36)">
        <constraints nullable="false"/>
      </column>
      <column name="order_id" type="varchar(36)">
        <constraints nullable="false"/>
      </column>
      <column name="payment_id" type="varchar(36)"/>
      <column name="gateway_type" type="varchar(50)">
        <constraints nullable="false"/>
      </column>
      <column name="gateway_order_id" type="varchar(255)"/>
      <column name="gateway_payment_id" type="varchar(255)"/>
      <column name="gateway_signature" type="varchar(512)"/>
      <column name="amount" type="decimal(12,2)">
        <constraints nullable="false"/>
      </column>
      <column name="currency" type="varchar(3)" defaultValue="INR"/>
      <column name="status" type="varchar(50)">
        <constraints nullable="false"/>
      </column>
      <column name="payment_method" type="varchar(50)"/>
      <column name="failure_reason" type="text"/>
      <column name="gateway_response" type="text"/>
      <column name="idempotency_key" type="varchar(255)"/>
      <column name="created_at" type="datetime"/>
      <column name="updated_at" type="datetime"/>
      <column name="completed_at" type="datetime"/>
    </createTable>

    <createIndex tableName="gateway_transactions" indexName="idx_gtx_tenant">
      <column name="tenant_id"/>
    </createIndex>

    <createIndex tableName="gateway_transactions" indexName="idx_gtx_order">
      <column name="order_id"/>
    </createIndex>

    <createIndex tableName="gateway_transactions" indexName="idx_gtx_gateway_order">
      <column name="gateway_order_id"/>
    </createIndex>

    <createIndex tableName="gateway_transactions" indexName="idx_gtx_gateway_payment">
      <column name="gateway_payment_id"/>
    </createIndex>

    <createIndex tableName="gateway_transactions" indexName="idx_gtx_idempotency">
      <column name="idempotency_key"/>
    </createIndex>
  </changeSet>

  <!-- Gateway Refunds Table -->
  <changeSet id="4-create-gateway-refunds" author="dev">
    <createTable tableName="gateway_refunds">
      <column name="id" type="varchar(36)">
        <constraints primaryKey="true" nullable="false"/>
      </column>
      <column name="transaction_id" type="varchar(36)">
        <constraints nullable="false"/>
      </column>
      <column name="gateway_refund_id" type="varchar(255)"/>
      <column name="amount" type="decimal(12,2)">
        <constraints nullable="false"/>
      </column>
      <column name="status" type="varchar(50)">
        <constraints nullable="false"/>
      </column>
      <column name="reason" type="text"/>
      <column name="gateway_response" type="text"/>
      <column name="created_at" type="datetime"/>
      <column name="processed_at" type="datetime"/>
    </createTable>

    <addForeignKeyConstraint
        baseTableName="gateway_refunds"
        baseColumnNames="transaction_id"
        referencedTableName="gateway_transactions"
        referencedColumnNames="id"
        constraintName="fk_refund_transaction"/>

    <createIndex tableName="gateway_refunds" indexName="idx_refund_transaction">
      <column name="transaction_id"/>
    </createIndex>
  </changeSet>

  <!-- Webhook Events Log -->
  <changeSet id="4-create-webhook-events" author="dev">
    <createTable tableName="gateway_webhook_events">
      <column name="id" type="varchar(36)">
        <constraints primaryKey="true" nullable="false"/>
      </column>
      <column name="gateway_type" type="varchar(50)">
        <constraints nullable="false"/>
      </column>
      <column name="event_type" type="varchar(100)"/>
      <column name="gateway_event_id" type="varchar(255)"/>
      <column name="payload" type="text"/>
      <column name="signature" type="varchar(512)"/>
      <column name="is_verified" type="boolean" defaultValueBoolean="false"/>
      <column name="is_processed" type="boolean" defaultValueBoolean="false"/>
      <column name="processing_error" type="text"/>
      <column name="created_at" type="datetime"/>
      <column name="processed_at" type="datetime"/>
    </createTable>

    <createIndex tableName="gateway_webhook_events" indexName="idx_webhook_event_id">
      <column name="gateway_event_id"/>
    </createIndex>
  </changeSet>

</databaseChangeLog>
