<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
    xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="
      http://www.liquibase.org/xml/ns/dbchangelog
      http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-4.9.xsd">

  <!-- Make payment gateway credential fields nullable for existing installations -->
  <!-- This changeset handles the case where the table was already created with NOT NULL constraints -->
  <changeSet id="8-make-payment-credentials-nullable" author="dev">
    <preConditions onFail="MARK_RAN">
      <and>
        <tableExists tableName="client_payment_configs"/>
        <columnExists tableName="client_payment_configs" columnName="api_key_encrypted"/>
        <not>
          <columnExists tableName="client_payment_configs" columnName="auto_capture_enabled"/>
        </not>
      </and>
    </preConditions>

    <!-- Drop NOT NULL constraint from api_key_encrypted -->
    <dropNotNullConstraint tableName="client_payment_configs" columnName="api_key_encrypted" columnDataType="text"/>
    
    <!-- Drop NOT NULL constraint from secret_key_encrypted -->
    <dropNotNullConstraint tableName="client_payment_configs" columnName="secret_key_encrypted" columnDataType="text"/>

    <!-- Add missing payment config fields for existing installations -->
    <addColumn tableName="client_payment_configs">
      <column name="auto_capture_enabled" type="boolean" defaultValueBoolean="true"/>
    </addColumn>

    <addColumn tableName="client_payment_configs">
      <column name="partial_refund_enabled" type="boolean" defaultValueBoolean="true"/>
    </addColumn>

    <addColumn tableName="client_payment_configs">
      <column name="webhook_url" type="varchar(500)"/>
    </addColumn>

    <rollback>
      <!-- Drop the added columns -->
      <dropColumn tableName="client_payment_configs" columnName="webhook_url"/>
      <dropColumn tableName="client_payment_configs" columnName="partial_refund_enabled"/>
      <dropColumn tableName="client_payment_configs" columnName="auto_capture_enabled"/>
      
      <!-- Re-add NOT NULL constraints (requires data cleanup first) -->
      <addNotNullConstraint tableName="client_payment_configs" columnName="api_key_encrypted" columnDataType="text"/>
      <addNotNullConstraint tableName="client_payment_configs" columnName="secret_key_encrypted" columnDataType="text"/>
    </rollback>
  </changeSet>

</databaseChangeLog>
